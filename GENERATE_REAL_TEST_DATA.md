# Generate Real Test Data for Payment Verification

## Problem

The "Invalid payment signature" error occurs because Razorpay signature verification requires a valid signature generated by Razorpay. Mock values won't work.

## Solution Options

### Option 1: Use Test Mode (Recommended for Development)

I've added test mode support that bypasses signature verification when:

- Signature starts with `test_`
- Order ID starts with `order_test` or `order_Mock`

**Updated Request (with test mode):**

```json
{
  "razorpayOrderId": "order_MockOrder123",
  "razorpayPaymentId": "pay_MockPayment123",
  "razorpaySignature": "test_bypass_signature_verification",
  "showtimeId": "real-showtime-id-from-db",
  "seats": ["real-seat-id-1", "real-seat-id-2"],
  "seatLabels": ["A1", "A2"],
  "totalAmount": 500.0,
  "customerName": "John Doe",
  "customerEmail": "john.doe@example.com",
  "customerPhone": "9876543210"
}
```

**cURL Command:**

```bash
curl -X POST http://localhost:8080/api/razorpay/verify-payment \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "razorpayOrderId": "order_MockOrder123",
    "razorpayPaymentId": "pay_MockPayment123",
    "razorpaySignature": "test_bypass_signature_verification",
    "showtimeId": "real-showtime-id",
    "seats": ["real-seat-id-1", "real-seat-id-2"],
    "seatLabels": ["A1", "A2"],
    "totalAmount": 500.0,
    "customerName": "John Doe",
    "customerEmail": "john.doe@example.com",
    "customerPhone": "9876543210"
  }'
```

---

### Option 2: Fetch Real Data from Database

Use the Python script to fetch real showtime and seat data:

**Prerequisites:**

```bash
pip install mysql-connector-python
```

**Run the script:**

```bash
python3 fetch_real_test_data.py
```

This will:

1. Connect to your database (using credentials from application.yml)
2. Find active showtimes
3. Find available seats
4. Generate a complete test request with real IDs
5. Save the request to `test_payment_request.json`

**Output:**

- Real showtime ID
- Real seat IDs
- Real user data
- Complete curl command

---

### Option 3: Create Real Razorpay Test Order

For end-to-end testing with real Razorpay signatures:

**Step 1: Create Order**

```bash
./create_real_razorpay_order.sh
```

Or manually:

```bash
# Login first
TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"your_password"}' | jq -r '.token')

# Create order
curl -X POST http://localhost:8080/api/razorpay/create-order \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 500.0,
    "showtimeId": "your-showtime-id",
    "currency": "INR"
  }'
```

**Step 2: Complete Payment in Razorpay Test Mode**

1. Use the order ID from Step 1
2. Go to Razorpay test checkout (integrate in frontend or use Razorpay test page)
3. Use test card:
   - Card: `4111 1111 1111 1111`
   - CVV: Any 3 digits
   - Expiry: Any future date
4. Complete payment

**Step 3: Use Real Payment Data**

After payment, Razorpay returns:

- `razorpay_order_id`
- `razorpay_payment_id`
- `razorpay_signature`

Use these in your verify-payment request.

---

## Complete Workflow

### Quick Test (Test Mode)

1. **Get real data:**

```bash
python3 fetch_real_test_data.py
```

2. **Use test mode signature:**

```bash
# Edit test_payment_request.json and change signature to:
"razorpaySignature": "test_bypass_signature_verification"

# Then use the curl command from the script output
```

### Full Test (Real Razorpay)

1. **Get real data:**

```bash
python3 fetch_real_test_data.py
```

2. **Create Razorpay order:**

```bash
./create_real_razorpay_order.sh
```

3. **Complete payment** using Razorpay test checkout

4. **Verify payment** with real Razorpay response data

---

## Example: Complete Test Request with Real Data

After running `fetch_real_test_data.py`, you'll get output like:

```json
{
  "razorpayOrderId": "order_MockOrder123",
  "razorpayPaymentId": "pay_MockPayment123",
  "razorpaySignature": "test_bypass_signature_verification",
  "showtimeId": "550e8400-e29b-41d4-a716-446655440000",
  "seats": ["seat-uuid-1", "seat-uuid-2"],
  "seatLabels": ["A1", "A2"],
  "totalAmount": 600.0,
  "customerName": "John Doe",
  "customerEmail": "john.doe@example.com",
  "customerPhone": "9876543210"
}
```

**cURL:**

```bash
curl -X POST http://localhost:8080/api/razorpay/verify-payment \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -H "Content-Type: application/json" \
  -d @test_payment_request.json
```

---

## Troubleshooting

### Database Connection Error

- Check MySQL is running: `mysql -u root -p`
- Verify credentials in `application.yml`
- Ensure database `revticket_db` exists

### No Showtimes Found

- Create a showtime through admin panel or API
- Ensure showtime status is `ACTIVE`
- Ensure showtime is in the future

### No Available Seats

- Initialize seats for the showtime
- Check if seats are already booked
- Verify seat status in database

### Still Getting Signature Error

- Make sure signature starts with `test_` for test mode
- Or use real Razorpay order/payment IDs
- Check logs: `Microservices-Backend/logs/payment.log`

---

## Files Created

1. **`fetch_real_test_data.py`** - Fetches real data from database
2. **`create_real_razorpay_order.sh`** - Creates Razorpay test order
3. **`test_payment_request.json`** - Generated test request (after running script)
